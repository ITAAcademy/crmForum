<!DOCTYPE html>
<html>

<head>
    <title>CrmForum</title>
    <div th:include="includes">...</div>
    <script th:src="@{/modules/ckeditor/ckeditor.js}"></script>
        <script th:src="@{/js/ckeditor_config.js}"></script>
    <script th:src="@{/js/topic_view.js}"></script>
    <script th:src="@{/libs/spoiler.js}"></script>
    <script th:src="@{/modules/ckeditor/plugins/bbcode/plugin.js}"></script>
</head>

<body>
    <div id="forumcontainer" class="container">
        <div class="wraper topics row">
            <div th:replace="head_template" th:with="categoriesTree=${categoriesTree}">...</div>
            <!-- Topic info -->
            <div class="topic_info">
                <h4 th:text="${topic.name}"></h4>
            </div>
            <ul class="topic-content">
                <li class="card-panel row" th:each="message,iterationStatus : ${messages}" th:with="indexCurrentMsg=${currentPage == 1 ? iterationStatus.count : iterationStatus.count == 1 ?  1 :iterationStatus.count+((currentPage-1)*9) + currentPage - 2}" th:id="@{'msg__${message.id}__'}">
                    <div class="user-panel col s12 m2 l2" style="">
                        <img class="circle sp" th:src="@{__${config['baseUrl']}__/images/avatars/__${message.author.avatar}__}" alt="" />
                        <div class="col s6 m12 l12">
                            <a class="user-name" th:href="@{__${config['baseUrl']}__/profile/__${message.author.id}__}" style="  " th:title="${message.author.getNickName()}"><div th:text="${message.author.getNickName()}"></div></a>
                            <ul class="user-contact">
                                <li><a th:href="@{__${config['baseUrl']}__/crmChat/#/private_dialog_view/__${message.author.id}__}" th:classappend="${user.isAnonymous()} ? disabled" data-position="bottom" data-delay="100" data-tooltip="Створити чат" class="btn-floating red tooltipped"><i class="material-icons">chat_bubble_outline</i></a></li>
                                <li><a th:href="@{__${config['baseUrl']}__/cabinet/?scenario=message&amp;receiver=__${message.author.id}__}" th:classappend="${user.isAnonymous()} ? disabled" data-position="bottom" data-delay="100" data-tooltip="Відправити приватне повідомлення" class="btn-floating green darken-1 tooltipped"><i class="material-icons">email</i></a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="s12 m10 l10 user-msg" >
                        <p style="text-align: left; padding-left: 20px; font-size: 18px;">
                            <!--preloader
                            <div class="preloader-wrapper sk-circle">
                                <div class="sk-circle1 sk-child"></div>
                                <div class="sk-circle2 sk-child"></div>
                                <div class="sk-circle3 sk-child"></div>
                                <div class="sk-circle4 sk-child"></div>
                                <div class="sk-circle5 sk-child"></div>
                                <div class="sk-circle6 sk-child"></div>
                                <div class="sk-circle7 sk-child"></div>
                                <div class="sk-circle8 sk-child"></div>
                                <div class="sk-circle9 sk-child"></div>
                                <div class="sk-circle10 sk-child"></div>
                                <div class="sk-circle11 sk-child"></div>
                                <div class="sk-circle12 sk-child"></div>
                            </div>
                            /preloader -->
                            <div class="topic_message_text" th:utext="${bbcode.process(message.body)}" th:id  ="@{'topicMessage__${indexCurrentMsg}__'}"></div>
                            <br/>
                        </p>
                    </div>
                    <div style="clear:both;"></div>
                    <!-- Post prety time -->
                    <p class="topic-time" th:text="${prettyTime.format(message.date)}">15:11 10.20.15</p>
                    <!-- Counter -->
                    <a href="#!" style="position: absolute;bottom: 35px;left: 26px;">
                        <i class="material-icons">grade</i>
                        <i th:text="    №__${indexCurrentMsg}__"></i>
                    </a>
                    <!-- Post controll btn -->
                    <div th:if="${!user.isAnonymous()}" class="fixed-action-btn horizontal post-controll">
                        <a class="btn-floating btn-middle red">
                            <i class="large material-icons">menu</i>
                        </a>
                        <ul>
                            <li th:if="${canEditMap.get(message.id)}"><a href="#remove" class="btn-floating red modal-trigger"><i class="material-icons">delete</i></a></li>
                            <li th:if="${canEditMap.get(message.id)}"><a href="#edit00" th:onclick="'runEditPost(' + ${message.id} + ')'" class="btn-floating green"><i class="material-icons">mode_edit</i></a></li>
                            <li><a class="btn-floating blue" th:onclick="@{'javascript:quotation(\'__${indexCurrentMsg}__\',\'__${message.author.login}__\')'}"><i class="material-icons">email</i></a></li>
                        </ul>
                    </div>
                </li>
            </ul>
            <form id="addMessageForm" th:if="${!user.isAnonymous()}" th:action="@{/messages/add/__${topic.id}__}" method="POST">
                <textarea cols="80" id="ckeditor" name="text" rows="10"></textarea>
                <button id="submitcke" class="waves-effect waves-light btn" style="background-color: rgb(43, 87, 154);width: 100%;border-radius: 0px;box-shadow: none;" th:onclick="@{'javascript:addMessage(event,\'__${#httpServletRequest.getContextPath()}__/messages/add/__${topic.id}__\')'}" name="action">Відправити
                    <i class="material-icons right">send</i>
                </button>
            </form>
        </div>
        <div class="page-list row">
            <span th:include="pagination_template" th:with="pagesCount=${pagesCount}, currentPage=${currentPage}, link='/view/topic/__${topicId}__/'">...</span>
        </div>
    </div>
    <div th:if="${!user.isAnonymous()}" class="fixed-action-btn  back-to-top" style="bottom: 45px; right: 24px;">
        <a class="btn-floating btn-large waves-effect waves-light blue darken-2"><i class="material-icons">navigation</i></a>
    </div>
</body>
<!-- Edit modal window -->
<div id="edit" class="modal bottom-sheet modal-fixed-footer" style="max-height: 90%;overflow: hidden">
    <form id="edit_form" method="post">
        <div class="modal-content">
            <h4>Редагування посту</h4>
            <h5 id="edir_err" style="color:red"></h5>
            <div class="row">
                <div class="input-field col s12" style="postition: absolute; min-height: 70%;overflow: hidden">
                    <textarea cols="20" id="ckeditor_edit" name="topic_text" rows="10">
                    </textarea>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a style="" class="waves-effect waves-green btn-flat" onclick="runUpdatePost()">Внести зміни</a>
            <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Відмінити</a>
        </div>
    </form>
</div>
<!-- Remove modal window -->
<div id="remove" class="modal">
    <div class="modal-content">
        <h4>Видалення запису</h4>
        <p>Ви точно хочите видалити запис?</p>
    </div>
    <div class="modal-footer">
        <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Так</a>
        <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Ні</a>
    </div>
</div>

</html>
